<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAN Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --surface: rgba(31, 41, 55, 0.7);
            --text: #f3f4f6;
            --text-sub: #9ca3af;
            --matrix: #06b6d4;
            --primary: #8b5cf6;
            --danger: #ef4444;
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: var(--text);
            margin: 0;
            padding: 2rem;
            display: flex;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            height: 90vh;
            overflow: hidden;
            padding-bottom: 50px;
        }

        .glass-panel {
            background: var(--surface);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .dev-footer {
            position: fixed;
            bottom: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            color: var(--text-sub);
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 100;
            opacity: 0.7;
            font-weight: 300;
            letter-spacing: 1px;
        }

        #branding-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            z-index: 9999;
            /* animation removed for JS control */
        }

        .popup-title {
            font-size: 3rem;
            font-weight: 700;
            color: var(--matrix);
            text-shadow: 0 0 10px var(--matrix);
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar {
            flex: 0 0 320px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .card {
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(5px);
            padding: 1.2rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: var(--matrix);
        }

        .matrix-log {
            background: rgba(0, 0, 0, 0.8);
            color: var(--matrix);
            font-family: 'Consolas', 'Monaco', monospace;
            height: 250px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid var(--matrix);
            border-radius: 8px;
            font-size: 1rem;
            line-height: 1.5;
            margin-top: auto;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            text-shadow: 0 0 5px var(--matrix);
        }

        .btn-action {
            background: #374151;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
            transition: 0.2s;
        }

        .btn-action:hover {
            background: var(--primary);
        }

        .btn-danger:hover {
            background: var(--danger);
        }

        .progress-bar-bg {
            background: #374151;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-bar-fill {
            background: var(--matrix);
            height: 100%;
            transition: width 0.2s;
        }

        textarea {
            width: 100%;
            height: 80px;
            background: #111827;
            color: var(--text);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 10px;
            resize: none;
            box-sizing: border-box;
            font-family: monospace;
        }

        .file-list-container {
            flex: 1;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .file-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 0.5fr;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #374151;
        }

        .file-item:hover {
            background: #1f2937;
        }

        a {
            color: var(--matrix);
            text-decoration: none;
        }

        @media (max-width: 900px) {
            body {
                padding: 1rem;
                height: auto;
                overflow: auto;
                flex-direction: column;
            }

            .sidebar {
                display: block;
                width: 100%;
                flex: none;
            }

            .main-content {
                min-height: 80vh;
            }

            .file-item {
                grid-template-columns: 1fr 0.5fr;
            }

            .file-item div:nth-child(2),
            .file-item div:nth-child(3) {
                display: none;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }
    </style>
</head>

<body>
    <div id="branding-popup">
        <div style="text-align: center;">
            <div class="popup-title">LAN-FILE-TUNNEL</div>
            <div style="text-align:center; color:white; letter-spacing: 2px; margin-top: 10px;">SYSTEM ONLINE</div>
            <div id="loading-countdown"
                style="font-size: 5rem; font-weight: 700; color: var(--matrix); margin-top: 20px; text-shadow: 0 0 20px var(--matrix);">
                4</div>
            <div style="margin-top: 20px; font-size: 0.8rem; color: var(--text-sub); letter-spacing: 1px;">
                DEVELOPED BY GAJJARKASHAYAP
            </div>
        </div>
    </div>

    <!-- PIN Modal -->
    <div id="pin-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; justify-content:center; align-items:center;">
        <div
            style="background:var(--surface); padding:2rem; border-radius:12px; text-align:center; border:1px solid var(--matrix); width: 300px;">
            <h2 style="margin-top:0; color:var(--matrix);">AUTH REQUIRED</h2>
            <p style="color:var(--text-sub);">Enter PIN from Host PC</p>
            <input type="password" id="pin-input" maxlength="4"
                style="width: 100%; font-size: 2rem; text-align: center; letter-spacing: 10px; margin: 1rem 0; background: #000; border: 1px solid #374151; color: white;">
            <div style="display:flex; gap:10px;">
                <button class="btn-action" onclick="submitPin()">UNLOCK</button>
                <button class="btn-action" style="background:transparent; border:1px solid #374151;"
                    onclick="document.getElementById('pin-modal').style.display='none'">CANCEL</button>
            </div>
            <div id="pin-error" style="color: var(--danger); margin-top: 10px; display: none;">INVALID ACCESS CODE</div>
        </div>
    </div>

    <!-- Media Player Modal -->
    <div id="media-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:11000; flex-direction:column; justify-content:center; align-items:center;">
        <button
            style="position:absolute; top:20px; right:30px; background:none; border:none; color:white; font-size:3rem; cursor:pointer;"
            onclick="closeMedia()">√ó</button>
        <div id="media-container" style="width: 90%; max-width: 1000px; text-align: center;">
            <video id="video-player" controls
                style="width: 100%; max-height: 80vh; border-radius: 12px; box-shadow: 0 0 50px rgba(79, 70, 229, 0.3); display: none;"></video>
            <audio id="audio-player" controls style="width: 100%; margin-top: 20px; display: none;"></audio>
            <h2 id="media-title" style="margin-top:20px; color:white; font-weight:300;"></h2>
        </div>
    </div>

    <div class="dev-footer">Developed by KASHAYAP GAJJAR</div>

    <div class="sidebar">
        <div class="card" style="text-align: center;">
            <div style="font-weight: 700; color: var(--matrix);">SCAN TO CONNECT</div>
            <img src="data:image/png;base64,{{ qr_code }}" style="width: 120px; border-radius: 8px; margin: 10px 0;">
            <div
                style="font-family: monospace; background: #374151; padding: 5px; border-radius: 4px; overflow-wrap: break-word; font-size: 0.8rem;">
                {{ server_address }}
            </div>
            <div style="margin-top: 10px; font-size: 0.8rem;">
                {% if is_admin %}
                <span style="color:var(--matrix)">[PC ADMIN MODE]</span>
                <div id="admin-pin-display" onclick="revealPin()"
                    style="margin-top:5px; cursor:pointer; color:var(--text-sub); border: 1px dashed #374151; padding: 5px;">
                    üîë Click to show PIN
                </div>
                {% else %}
                [MOBILE CLIENT MODE]
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div style="font-weight: 600; margin-bottom: 5px;">Universal Clipboard üìã</div>
            <textarea id="clipboard-box" placeholder="Type here to sync text..."></textarea>
        </div>

        {% if is_admin %}
        <div class="card">
            <div style="font-weight: 600; margin-bottom: 5px; color: var(--matrix);">Command Center</div>
            <div style="display: flex; gap: 5px; flex-wrap:wrap;">
                <button class="btn-action" onclick="window.location.href='/admin'"
                    style="background:var(--primary);">üõ°Ô∏è
                    Manage Server</button>
                <button class="btn-action" onclick="pingDevices()">üì° Ping Devices</button>
                <button class="btn-action" onclick="restartServer()" style="background:#eab308;">üîÑ Restart</button>
                <button class="btn-action" onclick="exitApp()" style="background:var(--danger);">‚ùå Exit App</button>
            </div>
            <!-- Toggle for PIN -->
            <div style="margin-top: 10px; font-size: 0.9rem; cursor: pointer; color: var(--text-sub);"
                onclick="document.getElementById('pin-display').innerText = 'PIN: {{ remote_pin }}'">
                üîë Click to show PIN
                <div id="pin-display" style="color: var(--matrix); font-weight: bold; margin-top: 2px;">***</div>
            </div>
            <script>
                setTimeout(() => document.getElementById('pin-display').innerText = '***', 10000);
            </script>
        </div>
        {% else %}
        <!-- Mobile Client Control Panel (Hidden by default until auth) -->
        <div class="card" id="mobile-controls-locked">
            <div style="font-weight: 600; margin-bottom: 5px;">Remote Control üì≤</div>
            <button class="btn-action" onclick="document.getElementById('pin-modal').style.display='flex'">üîê
                Authenticate</button>
        </div>

        <div class="card" id="mobile-controls-unlocked" style="display:none; border-color: var(--matrix);">
            <div style="font-weight: 600; margin-bottom: 5px; color: var(--matrix);">Command Center üîì</div>
            <div style="font-weight: 600; margin-bottom: 5px; color: var(--matrix);">Command Center üîì</div>
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                <button class="btn-action" onclick="remoteLock()">üîí Lock PC</button>
                <button class="btn-action btn-danger" onclick="remoteShutdown()">üõë Shutdown</button>
            </div>
            <div id="cam-indicator"
                style="display:none; color:var(--danger); font-size:0.8rem; margin-top:5px; text-align:center;">üî¥
                STREAMING LIVE</div>
        </div>
        {% endif %}

        <div id="terminal-log" class="matrix-log">
            > [SYSTEM] Initializing...<br>
            > [SYSTEM] HTTP Server Active (Port 5000)...
        </div>
    </div>

    <div class="main-content glass-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <!-- Logo Place -->
                <img src="{{ url_for('static', filename='logo.png') }}"
                    style="height: 50px; border-radius: 8px; box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);"
                    onerror="this.style.display='none'">
                <h1
                    style="margin:0; text-shadow: 0 0 20px rgba(6, 182, 212, 0.5); font-weight: 700; letter-spacing: 1px;">
                    LAN SHARE</h1>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-action" onclick="window.location.href='/download_all'">üì¶ ZIP</button>
                <button class="btn-action" onclick="location.reload()">üîÑ</button>
            </div>
        </div>

        <div id="upload-progress-container" style="display: none; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                <span>Uploading... <span id="upload-status-text"></span></span>
                <span id="upload-percent">0%</span>
            </div>
            <div class="progress-bar-bg">
                <div id="upload-bar" class="progress-bar-fill" style="width: 0%;"></div>
            </div>
            <div style="text-align: right; font-size: 0.8rem; margin-top: 5px; color: var(--text-sub);">
                <span id="upload-speed">Waiting...</span>
            </div>
        </div>

        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <button class="btn-action" style="flex: 1; padding: 20px; font-size: 1.1rem; background: var(--primary);"
                onclick="document.getElementById('file-input').click()">üìÑ Upload Files</button>
            <button class="btn-action" style="flex: 1; padding: 20px; font-size: 1.1rem;"
                onclick="document.getElementById('folder-input').click()">üìÇ Upload Folder</button>
        </div>

        <input type="file" id="file-input" style="display: none;" multiple onchange="uploadFiles(this.files, false)">
        <input type="file" id="folder-input" style="display: none;" webkitdirectory multiple
            onchange="uploadFiles(this.files, true)">

        <div class="file-list-container">
            {% for file in files %}
            <div class="file-item" id="file-{{ file.name | replace('.', '-') }}">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <strong>{{ file.name }}</strong>
                </div>
                <div>{{ file.source }} {{ file.ip }}</div>
                <div style="color: var(--text-sub)">{{ file.time }}</div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    {% if '.mp4' in file.name.lower() or '.webm' in file.name.lower() or '.mov' in file.name.lower() %}
                    <a href="javascript:void(0)" onclick="playMedia('{{ file.name }}', 'video')">‚ñ∂Ô∏è Play</a>
                    {% elif '.mp3' in file.name.lower() or '.wav' in file.name.lower() or '.ogg' in file.name.lower() %}
                    <a href="javascript:void(0)" onclick="playMedia('{{ file.name }}', 'audio')">üéµ Play</a>
                    {% else %}
                    <a href="{{ url_for('download_file', filename=file.name) }}">‚¨áÔ∏è</a>
                    {% endif %}
                    <span style="cursor: pointer;" onclick="deleteFile('{{ file.name }}')">üóëÔ∏è</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        const socket = io();
        const logDiv = document.getElementById('terminal-log');
        let SESSION_PIN = null;

        {% if is_admin %}
        function revealPin() {
            fetch('/api/pin').then(r => r.json()).then(d => {
                if (d.pin) {
                    document.getElementById('admin-pin-display').innerHTML = `<span style="font-size:1.5rem; letter-spacing:3px; color:white;">${d.pin}</span>`;
                    setTimeout(() => { document.getElementById('admin-pin-display').innerHTML = 'üîë Click to show PIN'; }, 10000);
                }
            });
        }
        {% else %}
        function submitPin() {
            const pin = document.getElementById('pin-input').value;
            fetch('/api/auth/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pin: pin })
            }).then(r => r.json()).then(data => {
                if (data.status === 'success') {
                    SESSION_PIN = pin;
                    document.getElementById('pin-modal').style.display = 'none';
                    document.getElementById('mobile-controls-locked').style.display = 'none';
                    document.getElementById('mobile-controls-unlocked').style.display = 'block';
                } else {
                    document.getElementById('pin-error').style.display = 'block';
                }
            });
        }
        {% endif %}

        socket.on('server_log', function (data) {
            const newLine = document.createElement('div');
            newLine.innerHTML = `> ${data.msg}`;
            logDiv.appendChild(newLine);
            logDiv.scrollTop = logDiv.scrollHeight;
        });

        const clipBox = document.getElementById('clipboard-box');
        clipBox.addEventListener('input', function () {
            socket.emit('clipboard_change', { text: this.value });
        });
        socket.on('clipboard_update', function (data) {
            clipBox.value = data.text;
        });

        socket.on('ping_trigger', function () {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            oscillator.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.2);
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        });

        socket.on('new_file', () => location.reload());
        socket.on('file_deleted', (data) => {
            const el = document.getElementById('file-' + data.name.replace(/\./g, '-'));
            if (el) el.remove();
        });

        function uploadFiles(files, isFolder) {
            if (!files.length) return;
            const formData = new FormData();

            if (isFolder) {
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }
                const xhr = new XMLHttpRequest();
                document.getElementById('upload-progress-container').style.display = 'block';
                document.getElementById('upload-status-text').innerText = "Batch Folder Upload...";

                xhr.upload.onprogress = (e) => {
                    const p = (e.loaded / e.total) * 100;
                    document.getElementById('upload-bar').style.width = p + '%';
                    document.getElementById('upload-percent').innerText = Math.round(p) + '%';
                };
                xhr.onload = () => { location.reload(); };
                xhr.open('POST', '/upload_folder', true);
                xhr.send(formData);

            } else {
                uploadOneByOne(Array.from(files));
            }
        }

        function uploadOneByOne(fileList) {
            if (fileList.length === 0) {
                location.reload();
                return;
            }
            const file = fileList[0];
            const formData = new FormData();
            formData.append('file', file);

            const xhr = new XMLHttpRequest();
            document.getElementById('upload-progress-container').style.display = 'block';
            document.getElementById('upload-status-text').innerText = file.name;

            let prevTime = Date.now();
            let prevLoad = 0;

            xhr.upload.onprogress = (e) => {
                const p = (e.loaded / e.total) * 100;
                document.getElementById('upload-bar').style.width = p + '%';
                const now = Date.now();
                if (now - prevTime > 500) {
                    const speed = ((e.loaded - prevLoad) / (now - prevTime) / 1024 * 1000).toFixed(2);
                    document.getElementById('upload-speed').innerText = speed + ' MB/s';
                    prevTime = now;
                    prevLoad = e.loaded;
                }
            };

            xhr.onload = () => {
                uploadOneByOne(fileList.slice(1));
            };

            xhr.open('POST', '/upload', true);
            xhr.send(formData);
        }

        function deleteFile(name) {
            if (confirm('Delete ' + name + '?')) fetch('/delete/' + name, { method: 'POST' });
        }

        function remoteLock() {
            fetch('/remote/lock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pin: SESSION_PIN })
            }).then(handleControlResponse);
        }

        function remoteShutdown() {
            if (confirm('SHUTDOWN PC?')) {
                fetch('/remote/shutdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin: SESSION_PIN })
                }).then(handleControlResponse);
            }
        }

        function handleControlResponse(r) {
            if (r.status === 403) {
                alert('Session expired or unauthorized. Please re-authenticate.');
                if (document.getElementById('pin-modal')) {
                    document.getElementById('pin-modal').style.display = 'flex';
                }
            }
        }
        function pingDevices() { socket.emit('ping_device'); }

        function exitApp() {
            if (confirm("Exit App? This will stop the sharing server.")) {
                fetch('/api/control/kill_server', { method: 'POST' })
                    .then(() => {
                        alert("Server Stopped. Closing Window...");
                        window.close();
                        document.body.innerHTML = "<h1 style='color:white;text-align:center;margin-top:20%'>Server Stopped.<br>You can close this tab.</h1>";
                    })
                    .catch(() => window.close());
            }
        }

        function restartServer() {
            if (confirm("Restart Server? Clients may disconnect briefly.")) {
                fetch('/api/control/restart_server', { method: 'POST' })
                    .then(() => {
                        alert("Server is restarting... Page will reload in 5 seconds.");
                        setTimeout(() => location.reload(), 5000);
                    });
            }
        }

        // Media Player Logic
        function playMedia(filename, type) {
            const modal = document.getElementById('media-modal');
            const video = document.getElementById('video-player');
            const audio = document.getElementById('audio-player');
            const title = document.getElementById('media-title');
            const src = '/download/' + filename;

            modal.style.display = 'flex';
            title.innerText = filename;

            if (type === 'video') {
                video.src = src;
                video.style.display = 'block';
                audio.style.display = 'none';
                audio.pause();
                video.load();
                video.play().catch(e => console.log('Auto-play failed', e));
            } else {
                audio.src = src;
                audio.style.display = 'block';
                video.style.display = 'none';
                video.pause();
                audio.load();
                audio.play().catch(e => console.log('Auto-play failed', e));
            }
        }

        function closeMedia() {
            const modal = document.getElementById('media-modal');
            const video = document.getElementById('video-player');
            const audio = document.getElementById('audio-player');

            modal.style.display = 'none';
            video.pause();
            video.src = "";
            audio.pause();
            audio.src = "";
        }




        // Loading Screen Countdown
        document.addEventListener('DOMContentLoaded', () => {
            const el = document.getElementById('loading-countdown');
            const popup = document.getElementById('branding-popup');
            let count = 4;

            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    el.innerText = count;
                } else {
                    clearInterval(timer);
                    popup.style.transition = 'opacity 0.5s ease';
                    popup.style.opacity = '0';
                    setTimeout(() => popup.style.display = 'none', 500);
                }
            }, 1000);
        });
    </script>
</body>

</html>